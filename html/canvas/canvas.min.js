(function(){function e(e){var t=e.split(/\s+/);return"#"===t[t.length-1][0]?document.querySelector(e):document.querySelectorAll(e)}function t(e,t,n){for(var i=0;i<e.length;i++)for(var o=t.split(/\s+/),a=0;a<o.length;a++)navigator.userAgent.match(/(iPhone|iPod|Android|ios)/i)?o[a].indexOf("mouse")===-1&&e[i].addEventListener(o[a],function(e){e.preventDefault()},!1):e[i].addEventListener(o[a],function(e){n(e)},!1)}function n(e){for(var t=0;t<e.length;t++)e[t].style.display="initial"}function i(e){for(var t=0;t<e.length;t++)e[t].style.display="none"}function o(e,t){if(e.style.width=b+"px",e.width=b,e.style.height=w+"px",e.height=w,t){var n=e.getContext("2d");return n.strokeStyle=V,n.fillColor=$,n.lineWidth=Q,n.lineCap="round",n}}function a(e){A.value=e[0],A.previousElementSibling.innerText=e[0],L.value=e[1],L.previousElementSibling.innerText=e[1],q.value=e[2],q.previousElementSibling.innerText=e[2],z.value=e[3],z.previousElementSibling.innerText=e[3]}function r(e){1===p?(V="rgba("+e[0]+","+e[1]+","+e[2]+","+e[3]+")",Z=e,M.style.borderColor=V,I.style.background=V):($="rgba("+e[0]+","+e[1]+","+e[2]+","+e[3]+")",ee=e,D.style.background=$)}function l(e){Q=e,I.style.height=(Q>12?12:Q)+"px",I.style.background=V}function c(e){N=e,H.innerText=e}function u(e,t){var n=e.trace;if(n.length>3){t.beginPath(),t.lineWidth=e.lineWidth,t.strokeStyle=e.fillColor,t.moveTo(n[0].x,n[0].y);for(var i=1;i<n.length-2;i+=3)t.bezierCurveTo(n[i].x,n[i].y,n[i+1].x,n[i+1].y,n[i+2].x,n[i+2].y);t.lineTo(n[n.length-1].x,n[n.length-1].y)}t.stroke()}function s(e,t,n){var i=e.trace;if(i.length>1){n.beginPath(),n.lineWidth=e.lineWidth,n.strokeStyle=e.strokeColor,n.fillStyle=e.fillColor;var o=(i[1].x+i[0].x)/2,a=(i[1].x+i[0].x)/2;d(n,o,a,e.rotateDeg,function(){n.rect(i[0].x,i[0].y,i[1].x-i[0].x,i[1].y-i[0].y)}),0===t?n.stroke():1===t?n.fill():2==t&&(n.stroke(),n.fill())}}function h(e,t,n){var i=e.trace;if(i.length>1){n.beginPath(),n.lineWidth=e.lineWidth,n.strokeStyle=e.strokeColor,n.fillStyle=e.fillColor;var o=(i[1].x+i[0].x)/2,a=(i[1].y+i[0].y)/2,r=Math.sqrt(Math.pow(i[0].x-o,2)+Math.pow(i[0].y-a,2));n.arc(o,a,r,0,2*Math.PI),0===t?n.stroke():1===t?n.fill():2==t&&(n.stroke(),n.fill())}}function g(e,t){var n=e.trace;if(n.length>1){t.beginPath(),t.lineWidth=e.lineWidth,t.strokeStyle=e.strokeColor;var i=n[1].x-n[0].x,o=n[1].y-n[0].y,a=e.imageSource,r=(n[1].x+n[0].x)/2,l=(n[1].x+n[0].x)/2;d(t,r,l,e.rotateDeg,function(){t.drawImage(a,0,0,e.imgWidth,e.imgHeight,n[0].x,n[0].y,i,o)})}}function d(e,t,n,i,o){e.translate(t,n),e.rotate(Math.PI/180*i),e.translate(-t,-n),o(),e.translate(t,n),e.rotate(Math.PI/180*-i),e.translate(-t,-t)}function f(e,t){switch(e.style){case"line":u(e,t);break;case"rect":s(e,2,t);break;case"circle":h(e,2,t);break;case"strokerect":s(e,0,t);break;case"strokecircle":h(e,0,t);break;case"fillrect":s(e,1,t);break;case"fillcircle":h(e,1,t);break;case"fillrectimg":g(e,t)}}function v(){if(te.clearRect(0,0,b,w),te.beginPath(),te.fillStyle="rgba(255,255,255,1)",te.fillRect(0,0,b,w),x.length>0)for(var e=0;e<x.length;e++)f(x[e],te)}function m(e,t){t.trace&&t.trace.length>1&&f(t,e)}var y,p,b=window.innerWidth,w=window.innerHeight,x=[],k=[],S={},C=!1,T=e("#control"),W=e("#strokeColor"),P=e("#fillColor"),R=e("#linewidth"),E=e("#rotatedeg"),M=e("#strokeColor span")[0],D=e("#fillColor span")[0],I=e("#linewidth span")[0],H=e("#rotatedeg span")[0],A=e("#red"),L=e("#green"),q=e("#blue"),z=e("#opacity"),U=e("#width"),X=e("#rotate"),Y=e("#resetRotate"),B=e(".rgbalabel"),F=e(".widthlabel"),O=e(".rotatelabel");styleSelecter=e("#styleSelecter"),clear=e("#clear"),undo=e("#undo"),redo=e("#redo"),insertImg=e("#insertImg"),downloadimg=e("#downloadimg");var _=e("#canvas"),j=e("#canvasmask"),G=e("#fileimg"),J=e("#img"),K="line",N=0,Q=1,V="rgba(0,0,0,1)",Z=[0,0,0,1],$="rgba(0,0,0,1)",ee=[0,0,0,1],te=o(_,!0),ne=o(j,!0);te.fillStyle="rgba(255,255,255,1)",te.fillRect(0,0,b,w),window.onresize=function(){b=window.innerWidth,w=window.innerHeight,o(_),o(j)};var ie=new FileReader;G.onchange=function(){var e=this;e=this.files[0],e.size<2097152?(ie.readAsDataURL(e),ie.onload=function(){y=this.result,J.src=y}):alert("图片不能大于2MB")},t([j],"touchstart mousedown",function(e){i([T]);var t=e.changedTouches?e.changedTouches[0]:e,n={x:t.pageX,y:t.pageY};if(S={style:K,lineWidth:Q,strokeColor:V,fillColor:$,rotateDeg:N,trace:[]},"fillrectimg"===K){if(y){var o=new Image;o.src=y,S.imgWidth=0,S.imgHeight=0,o.onload=function(){S.imgWidth=o.naturalWidth,S.imgHeight=o.naturalHeight,S.imageSource=o,S.trace[0]=n,C=!0}}}else S.trace.push(n),C=!0}),t([j],"touchmove mousemove",function(e){if(e.preventDefault(),C){var t=e.changedTouches?e.changedTouches[0]:e,n={x:t.pageX,y:t.pageY};if("line"==S.style){var i=S.trace[S.trace.length-1];Math.abs(n.x-i.x)+Math.abs(n.y-i.y)>.3*Q&&S.trace.push(n)}else S.trace[1]=n;ne.clearRect(0,0,b,w),m(ne,S)}}),t([j],"touchend touchcancel mouseup mouseleave",function(e){C&&(x.push(S),m(te,S),S={},ne.beginPath(),ne.clearRect(0,0,b,w),C=!1)}),t([clear],"touchstart mousedown",function(){S={},x=[],k=[],te.clearRect(0,0,b,w),te.beginPath()}),t([undo],"touchstart mousedown",function(){if(x.length>0){var e=x.pop();e.pos=x.length,k.push(e),te.clearRect(0,0,b,w),v()}}),t([redo],"touchstart mousedown",function(){if(k.length>0){for(var e,t=k.length-1;t>-1;t--){if(k[t].pos==x.length){e=k.pop();break}k.pop()}e&&(x.push(e),m(te,x[x.length-1]))}}),t([downloadimg],"touchstart mousedown",function(){"download"in document.createElement("a")?(downloadimg.href=_.toDataURL("image/png"),downloadimg.download="作品_"+(new Date).getTime()+".png"):alert("浏览器不支持下载")}),t([W],"touchstart mousedown",function(e){n([T]),n(B),i(F),i(O),a(Z),p=1}),t([P],"touchstart mousedown",function(e){n([T]),n(B),i(F),i(O),a(ee),p=2}),t([R],"touchstart mousedown",function(){i(B),i(O),n([T]),n(F)}),t([E],"touchstart mousedown",function(){i(B),i(F),n([T]),n(O)}),t([A,L,q,z],"change",function(e){var t=e.target;r([A.value,L.value,q.value,z.value]),t.previousElementSibling.innerText=t.value}),t([U],"change",function(e){var t=e.target;l(t.value),t.previousElementSibling.innerText=t.value}),t([X],"change",function(e){var t=e.target;c(t.value),t.previousElementSibling.innerText=t.value}),t([Y],"touchstart mousedown",function(t){c(0),X.value=0,e(".rotatelabel span")[0].innerText=0}),t([styleSelecter],"change",function(e){var t=e.target;K=t.value})})();
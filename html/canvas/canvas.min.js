(function(){function e(e){var t=e.split(/\s+/);return"#"===t[t.length-1][0]?document.querySelector(e):document.querySelectorAll(e)}function t(e,t,r){me=function(e){r(e)};for(var n=0;n<e.length;n++)for(var o=t.split(/\s+/),a=0;a<o.length;a++)P?o[a].indexOf("mouse")===-1&&e[n].addEventListener(o[a],me,!1):e[n].addEventListener(o[a],me,!1)}function r(e,t,r){for(var n=0;n<e.length;n++)for(var o=t.split(/\s+/),a=0;a<o.length;a++)P?o[a].indexOf("mouse")===-1&&e[n].removeEventListener(o[a],me,!1):e[n].removeEventListener(o[a],me,!1)}function n(e){for(var t=0;t<e.length;t++)e[t].style.display="initial"}function o(e){for(var t=0;t<e.length;t++)e[t].style.display="none"}function a(e,t){if(e.style.width=W+"px",e.width=W,e.style.height=R+"px",e.height=R,t){var r=e.getContext("2d");return r.strokeStyle=he,r.fillColor=fe,r.lineWidth=se,r.lineCap="round",r}}function i(e){X.value=e[0],X.previousElementSibling.innerText=e[0],Y.value=e[1],Y.previousElementSibling.innerText=e[1],F.value=e[2],F.previousElementSibling.innerText=e[2],J.value=e[3],J.previousElementSibling.innerText=e[3]}function l(e){1===C?(he="rgba("+e[0]+","+e[1]+","+e[2]+","+e[3]+")",ge=e,z.style.borderColor=he):(fe="rgba("+e[0]+","+e[1]+","+e[2]+","+e[3]+")",de=e,B.style.background=fe,$.style.background=fe)}function c(e){se=e,$.style.height=(se>12?12:se)+"px",$.style.background=fe}function u(e){ue=e,q.innerText=e}function s(e,t){var r=e.trace;if(r.length>1){if(t.beginPath(),t.lineWidth=e.lineWidth,t.strokeStyle=e.fillColor,t.moveTo(r[0].x,r[0].y),r.length>3)for(var n=1;n<r.length-2;n+=3)t.bezierCurveTo(r[n].x,r[n].y,r[n+1].x,r[n+1].y,r[n+2].x,r[n+2].y);else for(var n=0;n<r.length-2;n++)t.lineTo(r[n].x,r[n].y);t.lineTo(r[r.length-1].x,r[r.length-1].y)}t.stroke()}function h(e,t){var r=e.trace;if(r.length>1){if(t.beginPath(),t.lineWidth=e.lineWidth,t.strokeStyle=e.strokeColor,t.fillStyle=e.fillColor,t.moveTo(r[0].x,r[0].y),r.length>3)for(var n=1;n<r.length-2;n+=3)t.bezierCurveTo(r[n].x,r[n].y,r[n+1].x,r[n+1].y,r[n+2].x,r[n+2].y);else for(var n=0;n<r.length-2;n++)t.lineTo(r[n].x,r[n].y);t.lineTo(r[r.length-1].x,r[r.length-1].y)}I?t.stroke():(t.lineTo(r[0].x,r[0].y),t.stroke(),t.fill())}function g(e,t,r){var n=e.trace;if(n.length>1){r.beginPath(),r.lineWidth=e.lineWidth,r.strokeStyle=e.strokeColor,r.fillStyle=e.fillColor;var o=n.length-1,a=(n[o].x+n[0].x)/2,i=(n[o].x+n[0].x)/2;v(r,a,i,e.rotateDeg,function(){r.rect(n[0].x,n[0].y,n[o].x-n[0].x,n[o].y-n[0].y)}),0===t?r.stroke():1===t?r.fill():2==t&&(r.stroke(),r.fill())}}function f(e,t,r){var n=e.trace;if(n.length>1){r.beginPath(),r.lineWidth=e.lineWidth,r.strokeStyle=e.strokeColor,r.fillStyle=e.fillColor;var o=n.length-1,a=(n[o].x+n[0].x)/2,i=(n[o].y+n[0].y)/2,l=Math.sqrt(Math.pow(n[0].x-a,2)+Math.pow(n[0].y-i,2));r.arc(a,i,l,0,2*Math.PI),0===t?r.stroke():1===t?r.fill():2==t&&(r.stroke(),r.fill())}}function d(e,t){var r=e.trace;if(r.length>1){t.beginPath(),t.lineWidth=e.lineWidth,t.strokeStyle=e.strokeColor;var n=r.length-1,o=r[n].x-r[0].x,a=r[n].y-r[0].y,i=e.imageSource,l=(r[n].x+r[0].x)/2,c=(r[n].x+r[0].x)/2;v(t,l,c,e.rotateDeg,function(){t.drawImage(i,0,0,e.imgWidth,e.imgHeight,r[0].x,r[0].y,o,a)})}}function v(e,t,r,n,o){e.translate(t,r),e.rotate(Math.PI/180*n),e.translate(-t,-r),o(),e.translate(t,r),e.rotate(Math.PI/180*-n),e.translate(-t,-t)}function b(e,t){switch(e.style){case"line":s(e,t);break;case"rect":g(e,2,t);break;case"circle":f(e,2,t);break;case"strokerect":g(e,0,t);break;case"strokecircle":f(e,0,t);break;case"fillrect":g(e,1,t);break;case"fillcircle":f(e,1,t);break;case"fillrectimg":d(e,t);break;case"drawPolygon":h(e,t)}}function m(){if(ve.clearRect(0,0,W,R),ve.beginPath(),ve.fillStyle="rgba(255,255,255,1)",ve.fillRect(0,0,W,R),arrs.length>0)for(var e=0;e<arrs.length;e++)b(arrs[e],ve)}function y(e,t){t.trace&&t.trace.length>1&&b(t,e)}function p(e){var t;if("object"==typeof e)for(var r in e)"Array"==e.constructor.name?(t=t||[],t[r]=p(e[r])):(t=t||{},t[r]=p(e[r]));else t=e;return t}function w(e){if(arrs.length>0)var t=0,r=2,n=setInterval(function(){var o=p(arrs[t]);o.trace=o.trace.slice(0,r),ve.clearRect(0,0,W,R),ve.fillStyle="rgba(255,255,255,1)",ve.fillRect(0,0,W,R);for(var a=0;a<t;a++)b(arrs[a],ve);b(o,ve),r++,arrs[t].trace.length==r&&(t++,r=2,t==arrs.length&&(clearInterval(n),e&&e()))},30)}function x(e,t,r){var n=function(r){switch(r){case 1:var n=new Image;n.src=e,n.onload=function(){t&&t(n)},n.onerror=function(){t&&t(!1)};break;case 2:var o=document.createElement("script");o.src=e,o.onload=function(){t&&t(!0)},o.onerror=function(){t&&t(!1)},document.body.appendChild(o);break;case 3:var a=new Audio;a.src=e,t&&t(a),document.body.appendChild(a)}};return e?void(r?n(r):e.match(/\.png|jpg|jpeg$/)?n(1):e.match(/\.js$/)?n(2):e.match(/\.mp3$/)&&n(3)):void(t&&t(!1))}function k(e){var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)","i"),r=window.location.search.substr(1).match(t);return null!=r?unescape(r[2]):null}function j(){E=!0,t([ae],"touchmove mousemove",function(e){if(e.preventDefault(),I){var t=e.changedTouches?e.changedTouches[0]:e,r={x:t.pageX,y:t.pageY};if("line"==currObj.style||"drawPolygon"==currObj.style){var n=currObj.trace[currObj.trace.length-1];Math.abs(r.x-n.x)+Math.abs(r.y-n.y)>.3*se&&currObj.trace.push(r)}else k("edit")?currObj.trace.push(r):currObj.trace[1]=r;be.clearRect(0,0,W,R),y(be,currObj)}})}function O(){E=!1,r([ae],"touchmove mousemove",function(e){})}function S(){A&&Z.removeChild(e("option:last-child")[0]),j(),t([ae],"touchstart mousedown",function(e){redoArr=[],o([L]);var t=e.changedTouches?e.changedTouches[0]:e,r={x:t.pageX,y:t.pageY};if(currObj={style:ce,lineWidth:se,strokeColor:he,fillColor:fe,rotateDeg:ue,trace:[]},"fillrectimg"===ce){if(T){var n=new Image;n.src=T,currObj.imgWidth=0,currObj.imgHeight=0,n.onload=function(){currObj.imgWidth=n.naturalWidth,currObj.imgHeight=n.naturalHeight,currObj.imageSource=n,currObj.trace[0]=r,I=!0}}}else currObj.trace.push(r),I=!0}),t([ae],"touchend touchcancel mouseup mouseleave",function(e){I&&currObj.trace.length>1&&(I=!1,arrs.push(currObj),y(ve,currObj),currObj={},be.beginPath(),be.clearRect(0,0,W,R))}),t([ee],"touchstart mousedown",function(){currObj={},arrs=[],redoArr=[],ve.clearRect(0,0,W,R),ve.beginPath()}),t([te],"touchstart mousedown",function(){if(arrs.length>0){var e=arrs.pop();e.pos=arrs.length,redoArr.push(e),ve.clearRect(0,0,W,R),m()}}),t([re],"touchstart mousedown",function(){redoArr.length>0&&(arrs.push(redoArr.pop()),y(ve,arrs[arrs.length-1]))}),t([ne],"touchstart mousedown",function(e){var t=e.target;if(O(),A&&window.Blob){var r="arrs="+JSON.stringify(arrs);t.download="canvasQuery.js";var n=new Blob([r],{type:"text/javascript"}),o=window.URL.createObjectURL(n);t.href=o}else P?ne.href=oe.toDataURL("image/png"):"download"in document.createElement("a")?(ne.href=oe.toDataURL("image/png"),ne.download="作品_"+(new Date).getTime()+".png"):alert("浏览器不支持下载")}),t([ne],"touchend touchcancel mouseup",function(){setTimeout(function(){E||j()})}),t([M],"touchstart mousedown",function(e){n([L]),n(G),o(K),o(V),i(ge),C=1}),t([D],"touchstart mousedown",function(e){n([L]),n(G),o(K),o(V),i(de),C=2}),t([H],"touchstart mousedown",function(){o(G),o(V),n([L]),n(K)}),t([U],"touchstart mousedown",function(){o(G),o(K),n([L]),n(V)}),t([X,Y,F,J],"change",function(e){var t=e.target;l([X.value,Y.value,F.value,J.value]),t.previousElementSibling.innerText=t.value}),t([N],"change",function(e){var t=e.target;c(t.value),t.previousElementSibling.innerText=t.value}),t([Q],"change",function(e){var t=e.target;u(t.value),t.previousElementSibling.innerText=t.value}),t([_],"touchstart mousedown",function(t){u(0),Q.value=0,e(".rotatelabel span")[0].innerText=0}),t([Z],"change",function(e){var t=e.target;ce=t.value})}window.arrs=[],window.redoArr=[],window.currObj={};var T,C,W=window.innerWidth,R=window.innerHeight,P=!!navigator.userAgent.match(/(iPhone|iPod|Android|ios)/i),E=!1,A=k("edit"),I=!1,L=e("#control"),M=e("#strokeColor"),D=e("#fillColor"),H=e("#linewidth"),U=e("#rotatedeg"),z=e("#strokeColor span")[0],B=e("#fillColor span")[0],$=e("#linewidth span")[0],q=e("#rotatedeg span")[0],X=e("#red"),Y=e("#green"),F=e("#blue"),J=e("#opacity"),N=e("#width"),Q=e("#rotate"),_=e("#resetRotate"),G=e(".rgbalabel"),K=e(".widthlabel"),V=e(".rotatelabel"),Z=e("#styleSelecter"),ee=e("#clear"),te=e("#undo"),re=e("#redo"),ne=(e("#insertImg"),e("#downloadimg")),oe=e("#canvas"),ae=e("#canvasmask"),ie=e("#fileimg"),le=e("#img"),ce="line",ue=0,se=1,he="rgba(0,0,0,1)",ge=[0,0,0,1],fe="rgba(0,0,0,1)",de=[0,0,0,1],ve=a(oe,!0),be=a(ae,!0);ve.fillStyle="rgba(255,255,255,1)",ve.fillRect(0,0,W,R),window.onresize=function(){W=window.innerWidth,R=window.innerHeight,a(oe),a(ae),m()};var me,ye=new FileReader;if(ie.onchange=function(){var e=this;e=this.files[0],e.size<2097152?(ye.readAsDataURL(e),ye.onload=function(){T=this.result,le.src=T}):alert("图片不能大于2MB")},k("url")){var pe,we=e("#dialog"),xe=e("#animation");o([e("#optionsBottom"),e("#optionsTop")]),n([we]);var ke=k("url"),je=k("music"),Oe=!1;x(ke,function(e){e&&(Oe?w():Oe=!0)}),x(je,function(e){pe=e,pe.loop=!0,pe.autoplay=!0}),t([xe],"touchstart mousedown",function(e){Oe?w():Oe=!0,pe.play(),o([we])})}else S()})();
(function(){function e(e){var t=e.split(/\s+/);return"#"===t[t.length-1][0]?document.querySelector(e):document.querySelectorAll(e)}function t(e,t,n){w=function(e){n(e)};for(var i=0;i<e.length;i++)for(var o=t.split(/\s+/),r=0;r<o.length;r++)C?o[r].indexOf("mouse")===-1&&e[i].addEventListener(o[r],w,!1):e[i].addEventListener(o[r],w,!1)}function n(e,t,n){for(var i=0;i<e.length;i++)for(var o=t.split(/\s+/),r=0;r<o.length;r++)C?o[r].indexOf("mouse")===-1&&e[i].removeEventListener(o[r],w,!1):e[i].removeEventListener(o[r],w,!1)}function i(e){for(var t=0;t<e.length;t++)e[t].style.display="initial"}function o(e){for(var t=0;t<e.length;t++)e[t].style.display="none"}function r(e,t){if(e.style.width=S+"px",e.width=S,e.style.height=T+"px",e.height=T,t){var n=e.getContext("2d");return n.strokeStyle=ce,n.fillColor=se,n.lineWidth=le,n.lineCap="round",n}}function a(e){X.value=e[0],X.previousElementSibling.innerText=e[0],Y.value=e[1],Y.previousElementSibling.innerText=e[1],B.value=e[2],B.previousElementSibling.innerText=e[2],F.value=e[3],F.previousElementSibling.innerText=e[3]}function l(e){1===k?(ce="rgba("+e[0]+","+e[1]+","+e[2]+","+e[3]+")",ue=e,q.style.borderColor=ce,U.style.background=ce):(se="rgba("+e[0]+","+e[1]+","+e[2]+","+e[3]+")",he=e,z.style.background=se)}function c(e){le=e,U.style.height=(le>12?12:le)+"px",U.style.background=ce}function u(e){ae=e,O.innerText=e}function s(e,t){var n=e.trace;if(n.length>3){t.beginPath(),t.lineWidth=e.lineWidth,t.strokeStyle=e.fillColor,t.moveTo(n[0].x,n[0].y);for(var i=1;i<n.length-2;i+=3)t.bezierCurveTo(n[i].x,n[i].y,n[i+1].x,n[i+1].y,n[i+2].x,n[i+2].y);t.lineTo(n[n.length-1].x,n[n.length-1].y)}t.stroke()}function h(e,t,n){var i=e.trace;if(i.length>1){n.beginPath(),n.lineWidth=e.lineWidth,n.strokeStyle=e.strokeColor,n.fillStyle=e.fillColor;var o=(i[1].x+i[0].x)/2,r=(i[1].x+i[0].x)/2;d(n,o,r,e.rotateDeg,function(){n.rect(i[0].x,i[0].y,i[1].x-i[0].x,i[1].y-i[0].y)}),0===t?n.stroke():1===t?n.fill():2==t&&(n.stroke(),n.fill())}}function g(e,t,n){var i=e.trace;if(i.length>1){n.beginPath(),n.lineWidth=e.lineWidth,n.strokeStyle=e.strokeColor,n.fillStyle=e.fillColor;var o=(i[1].x+i[0].x)/2,r=(i[1].y+i[0].y)/2,a=Math.sqrt(Math.pow(i[0].x-o,2)+Math.pow(i[0].y-r,2));n.arc(o,r,a,0,2*Math.PI),0===t?n.stroke():1===t?n.fill():2==t&&(n.stroke(),n.fill())}}function f(e,t){var n=e.trace;if(n.length>1){t.beginPath(),t.lineWidth=e.lineWidth,t.strokeStyle=e.strokeColor;var i=n[1].x-n[0].x,o=n[1].y-n[0].y,r=e.imageSource,a=(n[1].x+n[0].x)/2,l=(n[1].x+n[0].x)/2;d(t,a,l,e.rotateDeg,function(){t.drawImage(r,0,0,e.imgWidth,e.imgHeight,n[0].x,n[0].y,i,o)})}}function d(e,t,n,i,o){e.translate(t,n),e.rotate(Math.PI/180*i),e.translate(-t,-n),o(),e.translate(t,n),e.rotate(Math.PI/180*-i),e.translate(-t,-t)}function v(e,t){switch(e.style){case"line":s(e,t);break;case"rect":h(e,2,t);break;case"circle":g(e,2,t);break;case"strokerect":h(e,0,t);break;case"strokecircle":g(e,0,t);break;case"fillrect":h(e,1,t);break;case"fillcircle":g(e,1,t);break;case"fillrectimg":f(e,t)}}function m(){if(ge.clearRect(0,0,S,T),ge.beginPath(),ge.fillStyle="rgba(255,255,255,1)",ge.fillRect(0,0,S,T),E.length>0)for(var e=0;e<E.length;e++)v(E[e],ge)}function p(e,t){t.trace&&t.trace.length>1&&v(t,e)}function y(){W=!0,t([ne],"touchmove mousemove",function(e){if(e.preventDefault(),M){var t=e.changedTouches?e.changedTouches[0]:e,n={x:t.pageX,y:t.pageY};if("line"==R.style){var i=R.trace[R.trace.length-1];Math.abs(n.x-i.x)+Math.abs(n.y-i.y)>.3*le&&R.trace.push(n)}else R.trace[1]=n;fe.clearRect(0,0,S,T),p(fe,R)}})}function b(){W=!1,n([ne],"touchmove mousemove",function(e){})}var x,w,k,S=window.innerWidth,T=window.innerHeight,C=!!navigator.userAgent.match(/(iPhone|iPod|Android|ios)/i),W=!1,E=[],P=[],R={},M=!1,D=e("#control"),L=e("#strokeColor"),H=e("#fillColor"),I=e("#linewidth"),A=e("#rotatedeg"),q=e("#strokeColor span")[0],z=e("#fillColor span")[0],U=e("#linewidth span")[0],O=e("#rotatedeg span")[0],X=e("#red"),Y=e("#green"),B=e("#blue"),F=e("#opacity"),_=e("#width"),j=e("#rotate"),G=e("#resetRotate"),J=e(".rgbalabel"),K=e(".widthlabel"),N=e(".rotatelabel"),Q=e("#styleSelecter"),V=e("#clear"),Z=e("#undo"),$=e("#redo"),ee=(e("#insertImg"),e("#downloadimg")),te=e("#canvas"),ne=e("#canvasmask"),ie=e("#fileimg"),oe=e("#img"),re="line",ae=0,le=1,ce="rgba(0,0,0,1)",ue=[0,0,0,1],se="rgba(0,0,0,1)",he=[0,0,0,1],ge=r(te,!0),fe=r(ne,!0);ge.fillStyle="rgba(255,255,255,1)",ge.fillRect(0,0,S,T),window.onresize=function(){S=window.innerWidth,T=window.innerHeight,r(te),r(ne)};var de=new FileReader;ie.onchange=function(){var e=this;e=this.files[0],e.size<2097152?(de.readAsDataURL(e),de.onload=function(){x=this.result,oe.src=x}):alert("图片不能大于2MB")},y(),t([ne],"touchstart mousedown",function(e){o([D]);var t=e.changedTouches?e.changedTouches[0]:e,n={x:t.pageX,y:t.pageY};if(R={style:re,lineWidth:le,strokeColor:ce,fillColor:se,rotateDeg:ae,trace:[]},"fillrectimg"===re){if(x){var i=new Image;i.src=x,R.imgWidth=0,R.imgHeight=0,i.onload=function(){R.imgWidth=i.naturalWidth,R.imgHeight=i.naturalHeight,R.imageSource=i,R.trace[0]=n,M=!0}}}else R.trace.push(n),M=!0}),t([ne],"touchend touchcancel mouseup mouseleave",function(e){M&&(E.push(R),p(ge,R),R={},fe.beginPath(),fe.clearRect(0,0,S,T),M=!1)}),t([V],"touchstart mousedown",function(){R={},E=[],P=[],ge.clearRect(0,0,S,T),ge.beginPath()}),t([Z],"touchstart mousedown",function(){if(E.length>0){var e=E.pop();e.pos=E.length,P.push(e),ge.clearRect(0,0,S,T),m()}}),t([$],"touchstart mousedown",function(){if(P.length>0){for(var e,t=P.length-1;t>-1;t--){if(P[t].pos==E.length){e=P.pop();break}P.pop()}e&&(E.push(e),p(ge,E[E.length-1]))}}),t([ee],"touchstart mousedown",function(){b(),C?ee.href=te.toDataURL("image/png"):"download"in document.createElement("a")?(ee.href=te.toDataURL("image/png"),ee.download="作品_"+(new Date).getTime()+".png"):alert("浏览器不支持下载")}),t([ee],"touchend touchcancel mouseup",function(){setTimeout(function(){W||y()})}),t([L],"touchstart mousedown",function(e){i([D]),i(J),o(K),o(N),a(ue),k=1}),t([H],"touchstart mousedown",function(e){i([D]),i(J),o(K),o(N),a(he),k=2}),t([I],"touchstart mousedown",function(){o(J),o(N),i([D]),i(K)}),t([A],"touchstart mousedown",function(){o(J),o(K),i([D]),i(N)}),t([X,Y,B,F],"change",function(e){var t=e.target;l([X.value,Y.value,B.value,F.value]),t.previousElementSibling.innerText=t.value}),t([_],"change",function(e){var t=e.target;c(t.value),t.previousElementSibling.innerText=t.value}),t([j],"change",function(e){var t=e.target;u(t.value),t.previousElementSibling.innerText=t.value}),t([G],"touchstart mousedown",function(t){u(0),j.value=0,e(".rotatelabel span")[0].innerText=0}),t([Q],"change",function(e){var t=e.target;re=t.value})})();
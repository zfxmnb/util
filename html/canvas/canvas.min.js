(function(){function e(e){var t=e.split(/\s+/);return"#"===t[t.length-1][0]?document.querySelector(e):document.querySelectorAll(e)}function t(e,t,n){ce=function(e){n(e)};for(var o=0;o<e.length;o++)for(var i=t.split(/\s+/),r=0;r<i.length;r++)T?i[r].indexOf("mouse")===-1&&e[o].addEventListener(i[r],ce,!1):e[o].addEventListener(i[r],ce,!1)}function n(e,t,n){for(var o=0;o<e.length;o++)for(var i=t.split(/\s+/),r=0;r<i.length;r++)T?i[r].indexOf("mouse")===-1&&e[o].removeEventListener(i[r],ce,!1):e[o].removeEventListener(i[r],ce,!1)}function o(e){for(var t=0;t<e.length;t++)e[t].style.display="initial"}function i(e){for(var t=0;t<e.length;t++)e[t].style.display="none"}function r(e,t){if(e.style.width=k+"px",e.width=k,e.style.height=S+"px",e.height=S,t){var n=e.getContext("2d");return n.strokeStyle=ne,n.fillColor=ie,n.lineWidth=te,n.lineCap="round",n}}function a(e){O.value=e[0],O.previousElementSibling.innerText=e[0],X.value=e[1],X.previousElementSibling.innerText=e[1],Y.value=e[2],Y.previousElementSibling.innerText=e[2],B.value=e[3],B.previousElementSibling.innerText=e[3]}function l(e){1===x?(ne="rgba("+e[0]+","+e[1]+","+e[2]+","+e[3]+")",oe=e,A.style.borderColor=ne,z.style.background=ne):(ie="rgba("+e[0]+","+e[1]+","+e[2]+","+e[3]+")",re=e,q.style.background=ie)}function c(e){te=e,z.style.height=(te>12?12:te)+"px",z.style.background=ne}function u(e){ee=e,U.innerText=e}function s(e,t){var n=e.trace;if(n.length>3){t.beginPath(),t.lineWidth=e.lineWidth,t.strokeStyle=e.fillColor,t.moveTo(n[0].x,n[0].y);for(var o=1;o<n.length-2;o+=3)t.bezierCurveTo(n[o].x,n[o].y,n[o+1].x,n[o+1].y,n[o+2].x,n[o+2].y);t.lineTo(n[n.length-1].x,n[n.length-1].y)}t.stroke()}function h(e,t,n){var o=e.trace;if(o.length>1){n.beginPath(),n.lineWidth=e.lineWidth,n.strokeStyle=e.strokeColor,n.fillStyle=e.fillColor;var i=(o[1].x+o[0].x)/2,r=(o[1].x+o[0].x)/2;d(n,i,r,e.rotateDeg,function(){n.rect(o[0].x,o[0].y,o[1].x-o[0].x,o[1].y-o[0].y)}),0===t?n.stroke():1===t?n.fill():2==t&&(n.stroke(),n.fill())}}function g(e,t,n){var o=e.trace;if(o.length>1){n.beginPath(),n.lineWidth=e.lineWidth,n.strokeStyle=e.strokeColor,n.fillStyle=e.fillColor;var i=(o[1].x+o[0].x)/2,r=(o[1].y+o[0].y)/2,a=Math.sqrt(Math.pow(o[0].x-i,2)+Math.pow(o[0].y-r,2));n.arc(i,r,a,0,2*Math.PI),0===t?n.stroke():1===t?n.fill():2==t&&(n.stroke(),n.fill())}}function f(e,t){var n=e.trace;if(n.length>1){t.beginPath(),t.lineWidth=e.lineWidth,t.strokeStyle=e.strokeColor;var o=n[1].x-n[0].x,i=n[1].y-n[0].y,r=e.imageSource,a=(n[1].x+n[0].x)/2,l=(n[1].x+n[0].x)/2;d(t,a,l,e.rotateDeg,function(){t.drawImage(r,0,0,e.imgWidth,e.imgHeight,n[0].x,n[0].y,o,i)})}}function d(e,t,n,o,i){e.translate(t,n),e.rotate(Math.PI/180*o),e.translate(-t,-n),i(),e.translate(t,n),e.rotate(Math.PI/180*-o),e.translate(-t,-t)}function v(e,t){switch(e.style){case"line":s(e,t);break;case"rect":h(e,2,t);break;case"circle":g(e,2,t);break;case"strokerect":h(e,0,t);break;case"strokecircle":g(e,0,t);break;case"fillrect":h(e,1,t);break;case"fillcircle":g(e,1,t);break;case"fillrectimg":f(e,t)}}function m(){if(ae.clearRect(0,0,k,S),ae.beginPath(),ae.fillStyle="rgba(255,255,255,1)",ae.fillRect(0,0,k,S),W.length>0)for(var e=0;e<W.length;e++)v(W[e],ae)}function p(e,t){t.trace&&t.trace.length>1&&v(t,e)}function y(){C=!0,t([Q],"touchmove mousemove",function(e){if(e.preventDefault(),R){var t=e.changedTouches?e.changedTouches[0]:e,n={x:t.pageX,y:t.pageY};if("line"==P.style){var o=P.trace[P.trace.length-1];Math.abs(n.x-o.x)+Math.abs(n.y-o.y)>.3*te&&P.trace.push(n)}else P.trace[1]=n;le.clearRect(0,0,k,S),p(le,P)}})}function w(){C=!1,n([Q],"touchmove mousemove",function(e){})}var b,x,k=window.innerWidth,S=window.innerHeight,T=!!navigator.userAgent.match(/(iPhone|iPod|Android|ios)/i),C=!1,W=[],E=[],P={},R=!1,M=e("#control"),D=e("#strokeColor"),I=e("#fillColor"),L=e("#linewidth"),H=e("#rotatedeg"),A=e("#strokeColor span")[0],q=e("#fillColor span")[0],z=e("#linewidth span")[0],U=e("#rotatedeg span")[0],O=e("#red"),X=e("#green"),Y=e("#blue"),B=e("#opacity"),F=e("#width"),_=e("#rotate"),j=e("#resetRotate"),G=e(".rgbalabel"),J=e(".widthlabel"),K=e(".rotatelabel");styleSelecter=e("#styleSelecter"),clear=e("#clear"),undo=e("#undo"),redo=e("#redo"),insertImg=e("#insertImg"),downloadimg=e("#downloadimg");var N=e("#canvas"),Q=e("#canvasmask"),V=e("#fileimg"),Z=e("#img"),$="line",ee=0,te=1,ne="rgba(0,0,0,1)",oe=[0,0,0,1],ie="rgba(0,0,0,1)",re=[0,0,0,1],ae=r(N,!0),le=r(Q,!0);ae.fillStyle="rgba(255,255,255,1)",ae.fillRect(0,0,k,S),window.onresize=function(){k=window.innerWidth,S=window.innerHeight,r(N),r(Q)};var ce,ue=new FileReader;V.onchange=function(){var e=this;e=this.files[0],e.size<2097152?(ue.readAsDataURL(e),ue.onload=function(){b=this.result,Z.src=b}):alert("图片不能大于2MB")},y(),t([Q],"touchstart mousedown",function(e){i([M]);var t=e.changedTouches?e.changedTouches[0]:e,n={x:t.pageX,y:t.pageY};if(P={style:$,lineWidth:te,strokeColor:ne,fillColor:ie,rotateDeg:ee,trace:[]},"fillrectimg"===$){if(b){var o=new Image;o.src=b,P.imgWidth=0,P.imgHeight=0,o.onload=function(){P.imgWidth=o.naturalWidth,P.imgHeight=o.naturalHeight,P.imageSource=o,P.trace[0]=n,R=!0}}}else P.trace.push(n),R=!0}),t([Q],"touchend touchcancel mouseup mouseleave",function(e){R&&(W.push(P),p(ae,P),P={},le.beginPath(),le.clearRect(0,0,k,S),R=!1)}),t([clear],"touchstart mousedown",function(){P={},W=[],E=[],ae.clearRect(0,0,k,S),ae.beginPath()}),t([undo],"touchstart mousedown",function(){if(W.length>0){var e=W.pop();e.pos=W.length,E.push(e),ae.clearRect(0,0,k,S),m()}}),t([redo],"touchstart mousedown",function(){if(E.length>0){for(var e,t=E.length-1;t>-1;t--){if(E[t].pos==W.length){e=E.pop();break}E.pop()}e&&(W.push(e),p(ae,W[W.length-1]))}}),t([downloadimg],"touchstart mousedown",function(){w(),T?downloadimg.href=N.toDataURL("image/png"):"download"in document.createElement("a")?(downloadimg.href=N.toDataURL("image/png"),downloadimg.download="作品_"+(new Date).getTime()+".png"):alert("浏览器不支持下载")}),t([downloadimg],"touchend touchcancel mouseup",function(){setTimeout(function(){C||y()})}),t([D],"touchstart mousedown",function(e){o([M]),o(G),i(J),i(K),a(oe),x=1}),t([I],"touchstart mousedown",function(e){o([M]),o(G),i(J),i(K),a(re),x=2}),t([L],"touchstart mousedown",function(){i(G),i(K),o([M]),o(J)}),t([H],"touchstart mousedown",function(){i(G),i(J),o([M]),o(K)}),t([O,X,Y,B],"change",function(e){var t=e.target;l([O.value,X.value,Y.value,B.value]),t.previousElementSibling.innerText=t.value}),t([F],"change",function(e){var t=e.target;c(t.value),t.previousElementSibling.innerText=t.value}),t([_],"change",function(e){var t=e.target;u(t.value),t.previousElementSibling.innerText=t.value}),t([j],"touchstart mousedown",function(t){u(0),_.value=0,e(".rotatelabel span")[0].innerText=0}),t([styleSelecter],"change",function(e){var t=e.target;$=t.value})})();
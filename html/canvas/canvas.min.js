function $(e){var t=e.split(/\s+/);return"#"===t[t.length-1][0]?document.querySelector(e):document.querySelectorAll(e)}function on(e,t,n){Eventhandle=function(e){n(e)};for(var r=0;r<e.length;r++)for(var o=t.split(/\s+/),a=0;a<o.length;a++)isPhone?o[a].indexOf("mouse")===-1&&e[r].addEventListener(o[a],Eventhandle,!1):e[r].addEventListener(o[a],Eventhandle,!1)}function off(e,t,n){for(var r=0;r<e.length;r++)for(var o=t.split(/\s+/),a=0;a<o.length;a++)isPhone?o[a].indexOf("mouse")===-1&&e[r].removeEventListener(o[a],Eventhandle,!1):e[r].removeEventListener(o[a],Eventhandle,!1)}function show(e){for(var t=0;t<e.length;t++)e[t].style.display="initial"}function hide(e){for(var t=0;t<e.length;t++)e[t].style.display="none"}function canvasinit(e,t){if(e.style.width=winWidth+"px",e.width=winWidth,e.style.height=winHeight+"px",e.height=winHeight,t){var n=e.getContext("2d");return n.strokeStyle=strokeColor,n.fillColor=fillColor,n.lineWidth=lineWidth,n.lineCap="round",n}}function initColor(e){redRange.value=e[0],redRange.previousElementSibling.innerText=e[0],greenRange.value=e[1],greenRange.previousElementSibling.innerText=e[1],blueRange.value=e[2],blueRange.previousElementSibling.innerText=e[2],opacityRange.value=e[3],opacityRange.previousElementSibling.innerText=e[3]}function setColor(e){1===colorControl?(strokeColor="rgba("+e[0]+","+e[1]+","+e[2]+","+e[3]+")",strokeColorArr=e,scSelectSpan.style.borderColor=strokeColor):(fillColor="rgba("+e[0]+","+e[1]+","+e[2]+","+e[3]+")",fillColorArr=e,fcSelectSpan.style.background=fillColor,widthSelectSpan.style.background=fillColor)}function setWidth(e){lineWidth=e,widthSelectSpan.style.height=(lineWidth>12?12:lineWidth)+"px",widthSelectSpan.style.background=fillColor}function setRotate(e){rotateDeg=e,rotateSelectSpan.innerText=e}function drawLine(e,t){var n=e.trace;if(n.length>1){if(t.beginPath(),t.lineWidth=e.lineWidth,t.strokeStyle=e.fillColor,t.moveTo(n[0].x,n[0].y),n.length>3)for(var r=1;r<n.length-2;r+=3)t.bezierCurveTo(n[r].x,n[r].y,n[r+1].x,n[r+1].y,n[r+2].x,n[r+2].y);else for(var r=0;r<n.length-2;r++)t.lineTo(n[r].x,n[r].y);t.lineTo(n[n.length-1].x,n[n.length-1].y)}t.stroke()}function drawPolygon(e,t){var n=e.trace;if(n.length>1){if(t.beginPath(),t.lineWidth=e.lineWidth,t.strokeStyle=e.strokeColor,t.fillStyle=e.fillColor,t.moveTo(n[0].x,n[0].y),n.length>3)for(var r=1;r<n.length-2;r+=3)t.bezierCurveTo(n[r].x,n[r].y,n[r+1].x,n[r+1].y,n[r+2].x,n[r+2].y);else for(var r=0;r<n.length-2;r++)t.lineTo(n[r].x,n[r].y);t.lineTo(n[n.length-1].x,n[n.length-1].y)}start?t.stroke():(t.lineTo(n[0].x,n[0].y),t.stroke(),t.fill())}function drawRect(e,t,n){var r=e.trace;if(r.length>1){n.beginPath(),n.lineWidth=e.lineWidth,n.strokeStyle=e.strokeColor,n.fillStyle=e.fillColor;var o=r.length-1,a=(r[o].x+r[0].x)/2,i=(r[o].x+r[0].x)/2;rotate(n,a,i,e.rotateDeg,function(){n.rect(r[0].x,r[0].y,r[o].x-r[0].x,r[o].y-r[0].y)}),0===t?n.stroke():1===t?n.fill():2==t&&(n.stroke(),n.fill())}}function drawCircle(e,t,n){var r=e.trace;if(r.length>1){n.beginPath(),n.lineWidth=e.lineWidth,n.strokeStyle=e.strokeColor,n.fillStyle=e.fillColor;var o=r.length-1,a=(r[o].x+r[0].x)/2,i=(r[o].y+r[0].y)/2,l=Math.sqrt(Math.pow(r[0].x-a,2)+Math.pow(r[0].y-i,2));n.arc(a,i,l,0,2*Math.PI),0===t?n.stroke():1===t?n.fill():2==t&&(n.stroke(),n.fill())}}function drawImage(e,t){var n=e.trace;if(n.length>1){t.beginPath(),t.lineWidth=e.lineWidth,t.strokeStyle=e.strokeColor;var r=n.length-1,o=n[r].x-n[0].x,a=n[r].y-n[0].y,i=e.imageSource,l=(n[r].x+n[0].x)/2,c=(n[r].x+n[0].x)/2;rotate(t,l,c,e.rotateDeg,function(){t.drawImage(i,0,0,e.imgWidth,e.imgHeight,n[0].x,n[0].y,o,a)})}}function rotate(e,t,n,r,o){e.translate(t,n),e.rotate(Math.PI/180*r),e.translate(-t,-n),o(),e.translate(t,n),e.rotate(Math.PI/180*-r),e.translate(-t,-t)}function selectStyle(e,t){switch(e.style){case"line":drawLine(e,t);break;case"rect":drawRect(e,2,t);break;case"circle":drawCircle(e,2,t);break;case"strokerect":drawRect(e,0,t);break;case"strokecircle":drawCircle(e,0,t);break;case"fillrect":drawRect(e,1,t);break;case"fillcircle":drawCircle(e,1,t);break;case"fillrectimg":drawImage(e,t);break;case"drawPolygon":drawPolygon(e,t)}}function reDrawAll(){if(ctx.clearRect(0,0,winWidth,winHeight),ctx.beginPath(),ctx.fillStyle="rgba(255,255,255,1)",ctx.fillRect(0,0,winWidth,winHeight),arrs.length>0)for(var e=0;e<arrs.length;e++)selectStyle(arrs[e],ctx)}function reDrawCurr(e,t){t.trace&&t.trace.length>1&&selectStyle(t,e)}function moveEventOn(){moveOn=!0,on([canvasmask],"touchmove mousemove",function(e){if(e.preventDefault(),start){var t=e.changedTouches?e.changedTouches[0]:e,n={x:t.pageX,y:t.pageY};if("line"==currObj.style||"drawPolygon"==currObj.style){var r=currObj.trace[currObj.trace.length-1];Math.abs(n.x-r.x)+Math.abs(n.y-r.y)>.3*lineWidth&&currObj.trace.push(n)}else getUrlPrama("edit")?currObj.trace.push(n):currObj.trace[1]=n;maskctx.clearRect(0,0,winWidth,winHeight),reDrawCurr(maskctx,currObj)}})}function moveEventOff(){moveOn=!1,off([canvasmask],"touchmove mousemove",function(e){})}function clone(e){var t;if("object"==typeof e)for(var n in e)"Array"==e.constructor.name?(t=t||[],t[n]=clone(e[n])):(t=t||{},t[n]=clone(e[n]));else t=e;return t}function autoDraw(e){if(arrs.length>0)var t=0,n=2,r=setInterval(function(){var o=clone(arrs[t]);o.trace=o.trace.slice(0,n),ctx.clearRect(0,0,winWidth,winHeight),ctx.fillStyle="rgba(255,255,255,1)",ctx.fillRect(0,0,winWidth,winHeight);for(var a=0;a<t;a++)selectStyle(arrs[a],ctx);selectStyle(o,ctx),n++,arrs[t].trace.length==n&&(t++,n=2,t==arrs.length&&(clearInterval(r),e&&e()))},30)}function loadSource(e,t,n){var r=function(n){switch(n){case 1:var r=new Image;r.src=e,r.onload=function(){t&&t(r)},r.onerror=function(){t&&t(!1)};break;case 2:var o=document.createElement("script");o.src=e,o.onload=function(){t&&t(!0)},o.onerror=function(){t&&t(!1)},document.body.appendChild(o);break;case 3:var a=new Audio;a.src=e,a.onload=function(){t&&t(a)},a.onerror=function(){t&&t(!1)}}};return e?void(n?r(n):e.match(/\.png|jpg|jpeg$/)?r(1):e.match(/\.js$/)?r(2):e.match(/\.mp3$/)&&r(3)):void(t&&t(!1))}function getUrlPrama(e){var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)","i"),n=window.location.search.substr(1).match(t);return null!=n?unescape(n[2]):null}function main(){edit&&styleSelecter.removeChild($("option:last-child")[0]),moveEventOn(),on([canvasmask],"touchstart mousedown",function(e){redoArr=[],hide([controlDiv]);var t=e.changedTouches?e.changedTouches[0]:e,n={x:t.pageX,y:t.pageY};if(currObj={style:style,lineWidth:lineWidth,strokeColor:strokeColor,fillColor:fillColor,rotateDeg:rotateDeg,trace:[]},"fillrectimg"===style){if(base64){var r=new Image;r.src=base64,currObj.imgWidth=0,currObj.imgHeight=0,r.onload=function(){currObj.imgWidth=r.naturalWidth,currObj.imgHeight=r.naturalHeight,currObj.imageSource=r,currObj.trace[0]=n,start=!0}}}else currObj.trace.push(n),start=!0}),on([canvasmask],"touchend touchcancel mouseup mouseleave",function(e){start&&currObj.trace.length>1&&(start=!1,arrs.push(currObj),reDrawCurr(ctx,currObj),currObj={},maskctx.beginPath(),maskctx.clearRect(0,0,winWidth,winHeight))}),on([clear],"touchstart mousedown",function(){currObj={},arrs=[],redoArr=[],ctx.clearRect(0,0,winWidth,winHeight),ctx.beginPath()}),on([undo],"touchstart mousedown",function(){if(arrs.length>0){var e=arrs.pop();e.pos=arrs.length,redoArr.push(e),ctx.clearRect(0,0,winWidth,winHeight),reDrawAll()}}),on([redo],"touchstart mousedown",function(){redoArr.length>0&&(arrs.push(redoArr.pop()),reDrawCurr(ctx,arrs[arrs.length-1]))}),on([downloadimg],"touchstart mousedown",function(e){var t=e.target;if(moveEventOff(),edit&&window.Blob){var n="arrs="+JSON.stringify(arrs);t.download="canvasQuery.js";var r=new Blob([n],{type:"text/javascript"}),o=window.URL.createObjectURL(r);t.href=o}else isPhone?downloadimg.href=canvas.toDataURL("image/png"):"download"in document.createElement("a")?(downloadimg.href=canvas.toDataURL("image/png"),downloadimg.download="作品_"+(new Date).getTime()+".png"):alert("浏览器不支持下载")}),on([downloadimg],"touchend touchcancel mouseup",function(){setTimeout(function(){moveOn||moveEventOn()})}),on([scSelect],"touchstart mousedown",function(e){show([controlDiv]),show(rgbaRangeCon),hide(widthRangeCon),hide(rotateRangeCon),initColor(strokeColorArr),colorControl=1}),on([fcSelect],"touchstart mousedown",function(e){show([controlDiv]),show(rgbaRangeCon),hide(widthRangeCon),hide(rotateRangeCon),initColor(fillColorArr),colorControl=2}),on([widthSelect],"touchstart mousedown",function(){hide(rgbaRangeCon),hide(rotateRangeCon),show([controlDiv]),show(widthRangeCon)}),on([rotateSelect],"touchstart mousedown",function(){hide(rgbaRangeCon),hide(widthRangeCon),show([controlDiv]),show(rotateRangeCon)}),on([redRange,greenRange,blueRange,opacityRange],"change",function(e){var t=e.target;setColor([redRange.value,greenRange.value,blueRange.value,opacityRange.value]),t.previousElementSibling.innerText=t.value}),on([widthRange],"change",function(e){var t=e.target;setWidth(t.value),t.previousElementSibling.innerText=t.value}),on([rotateRange],"change",function(e){var t=e.target;setRotate(t.value),t.previousElementSibling.innerText=t.value}),on([resetRotate],"touchstart mousedown",function(e){setRotate(0),rotateRange.value=0,$(".rotatelabel span")[0].innerText=0}),on([styleSelecter],"change",function(e){var t=e.target;style=t.value})}var winWidth=window.innerWidth,winHeight=window.innerHeight,isPhone=!!navigator.userAgent.match(/(iPhone|iPod|Android|ios)/i),moveOn=!1,edit=getUrlPrama("edit"),arrs=[],redoArr=[],currObj={},base64,start=!1,colorControl,controlDiv=$("#control"),scSelect=$("#strokeColor"),fcSelect=$("#fillColor"),widthSelect=$("#linewidth"),rotateSelect=$("#rotatedeg"),scSelectSpan=$("#strokeColor span")[0],fcSelectSpan=$("#fillColor span")[0],widthSelectSpan=$("#linewidth span")[0],rotateSelectSpan=$("#rotatedeg span")[0],redRange=$("#red"),greenRange=$("#green"),blueRange=$("#blue"),opacityRange=$("#opacity"),widthRange=$("#width"),rotateRange=$("#rotate"),resetRotate=$("#resetRotate"),rgbaRangeCon=$(".rgbalabel"),widthRangeCon=$(".widthlabel"),rotateRangeCon=$(".rotatelabel"),styleSelecter=$("#styleSelecter"),clear=$("#clear"),undo=$("#undo"),redo=$("#redo"),insertImg=$("#insertImg"),downloadimg=$("#downloadimg"),canvas=$("#canvas"),canvasmask=$("#canvasmask"),fileimg=$("#fileimg"),img=$("#img"),style="line",rotateDeg=0,lineWidth=1,strokeColor="rgba(0,0,0,1)",strokeColorArr=[0,0,0,1],fillColor="rgba(0,0,0,1)",fillColorArr=[0,0,0,1],ctx=canvasinit(canvas,!0),maskctx=canvasinit(canvasmask,!0);ctx.fillStyle="rgba(255,255,255,1)",ctx.fillRect(0,0,winWidth,winHeight),window.onresize=function(){winWidth=window.innerWidth,winHeight=window.innerHeight,canvasinit(canvas),canvasinit(canvasmask)};var Eventhandle,render=new FileReader;if(fileimg.onchange=function(){var e=this;e=this.files[0],e.size<2097152?(render.readAsDataURL(e),render.onload=function(){base64=this.result,img.src=base64}):alert("图片不能大于2MB")},getUrlPrama("url")){var dialog=$("#dialog"),animation=$("#animation");hide([$("#optionsBottom"),$("#optionsTop")]),show([dialog]);var url=getUrlPrama("url"),audio=getUrlPrama("audio"),s=!1;loadSource(url,function(e){e&&loadSource(audio,function(e){s?autoDraw():s=!0})}),on([animation],"touchstart mousedown",function(e){s?autoDraw():s=!0,dialog.style.display="none"})}else main();
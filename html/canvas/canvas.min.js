(function(){function e(e){var t=e.split(/\s+/);return"#"===t[t.length-1][0]?document.querySelector(e):document.querySelectorAll(e)}function t(e,t,n){for(var i=0;i<e.length;i++)for(var r=t.split(/\s+/),o=0;o<r.length;o++)navigator.userAgent.match(/(iPhone|iPod|Android|ios)/i)?r[o].indexOf("mouse")===-1&&e[i].addEventListener(r[o],function(e){e.preventDefault(),n(e)},!1):e[i].addEventListener(r[o],function(e){e.preventDefault(),n(e)},!1)}function n(e){for(var t=0;t<e.length;t++)e[t].style.display="initial"}function i(e){for(var t=0;t<e.length;t++)e[t].style.display="none"}function r(e,t){if(e.style.width=b+"px",e.width=b,e.style.height=x+"px",e.height=x,t){var n=e.getContext("2d");return n.strokeStyle=Z,n.fillColor=_,n.lineWidth=V,n.lineCap="round",n}}function o(e){A.value=e[0],A.previousElementSibling.innerText=e[0],q.value=e[1],q.previousElementSibling.innerText=e[1],z.value=e[2],z.previousElementSibling.innerText=e[2],L.value=e[3],L.previousElementSibling.innerText=e[3]}function l(e){1===p?(Z="rgba("+e[0]+","+e[1]+","+e[2]+","+e[3]+")",$=e,M.style.borderColor=Z,D.style.background=Z):(_="rgba("+e[0]+","+e[1]+","+e[2]+","+e[3]+")",ee=e,I.style.background=_)}function a(e){V=e,D.style.height=(V>12?12:V)+"px",D.style.background=Z}function c(e){Q=e,H.innerText=e}function s(e,t){var n=e.trace;if(n.length>3){t.beginPath(),t.lineWidth=e.lineWidth,t.strokeStyle=e.fillColor,t.moveTo(n[0].x,n[0].y);for(var i=1;i<n.length-2;i+=3)t.bezierCurveTo(n[i].x,n[i].y,n[i+1].x,n[i+1].y,n[i+2].x,n[i+2].y);t.lineTo(n[n.length-1].x,n[n.length-1].y)}t.stroke()}function u(e,t,n){var i=e.trace;if(i.length>1){n.beginPath(),n.lineWidth=e.lineWidth,n.strokeStyle=e.strokeColor,n.fillStyle=e.fillColor;var r=(i[1].x+i[0].x)/2,o=(i[1].x+i[0].x)/2;f(n,r,o,e.rotateDeg,function(){n.rect(i[0].x,i[0].y,i[1].x-i[0].x,i[1].y-i[0].y)}),0===t?n.stroke():1===t?n.fill():2==t&&(n.stroke(),n.fill())}}function h(e,t,n){var i=e.trace;if(i.length>1){n.beginPath(),n.lineWidth=e.lineWidth,n.strokeStyle=e.strokeColor,n.fillStyle=e.fillColor;var r=(i[1].x+i[0].x)/2,o=(i[1].y+i[0].y)/2,l=Math.sqrt(Math.pow(i[0].x-r,2)+Math.pow(i[0].y-o,2));n.arc(r,o,l,0,2*Math.PI),0===t?n.stroke():1===t?n.fill():2==t&&(n.stroke(),n.fill())}}function g(e,t){var n=e.trace;if(n.length>1){t.beginPath(),t.lineWidth=e.lineWidth,t.strokeStyle=e.strokeColor;var i=n[1].x-n[0].x,r=n[1].y-n[0].y,o=e.imageSource,l=(n[1].x+n[0].x)/2,a=(n[1].x+n[0].x)/2;f(t,l,a,e.rotateDeg,function(){t.drawImage(o,0,0,e.imgWidth,e.imgHeight,n[0].x,n[0].y,i,r)})}}function f(e,t,n,i,r){e.translate(t,n),e.rotate(Math.PI/180*i),e.translate(-t,-n),r(),e.translate(t,n),e.rotate(Math.PI/180*-i),e.translate(-t,-t)}function d(e,t){switch(e.style){case"line":s(e,t);break;case"rect":u(e,2,t);break;case"circle":h(e,2,t);break;case"strokerect":u(e,0,t);break;case"strokecircle":h(e,0,t);break;case"fillrect":u(e,1,t);break;case"fillcircle":h(e,1,t);break;case"fillrectimg":g(e,t)}}function v(){if(te.clearRect(0,0,b,x),te.beginPath(),te.fillStyle="rgba(255,255,255,1)",te.fillRect(0,0,b,x),w.length>0)for(var e=0;e<w.length;e++)d(w[e],te)}function y(e,t){t.trace&&t.trace.length>1&&d(t,e)}var m,p,b=window.innerWidth,x=window.innerHeight,w=[],k=[],S={},C=!1,T=e("#control"),W=e("#strokeColor"),P=e("#fillColor"),R=e("#linewidth"),E=e("#rotatedeg"),M=e("#strokeColor span")[0],I=e("#fillColor span")[0],D=e("#linewidth span")[0],H=e("#rotatedeg span")[0],A=e("#red"),q=e("#green"),z=e("#blue"),L=e("#opacity"),X=e("#width"),Y=e("#rotate"),B=e("#resetRotate"),F=e(".rgbalabel"),O=e(".widthlabel"),U=e(".rotatelabel");styleSelecter=e("#styleSelecter"),clear=e("#clear"),undo=e("#undo"),redo=e("#redo"),insertImg=e("#insertImg");var j=e("#canvas"),G=e("#canvasmask"),J=e("#fileimg"),K=e("#img"),N="line",Q=0,V=1,Z="rgba(0,0,0,1)",$=[0,0,0,1],_="rgba(0,0,0,1)",ee=[0,0,0,1],te=r(j,!0),ne=r(G,!0);te.fillStyle="rgba(255,255,255,1)",te.fillRect(0,0,b,x),window.onresize=function(){b=window.innerWidth,x=window.innerHeight,r(j),r(G)};var ie=new FileReader;J.onchange=function(){var e=this;e=this.files[0],e.size<2097152?(ie.readAsDataURL(e),ie.onload=function(){m=this.result,K.src=m}):alert("图片不能大于2MB")},t([G],"touchstart mousedown",function(e){i([T]);var t=e.changedTouches?e.changedTouches[0]:e,n={x:t.pageX,y:t.pageY};if(S={style:N,lineWidth:V,strokeColor:Z,fillColor:_,rotateDeg:Q,trace:[]},"fillrectimg"===N){if(m){var r=new Image;r.src=m,S.imgWidth=0,S.imgHeight=0,r.onload=function(){S.imgWidth=r.naturalWidth,S.imgHeight=r.naturalHeight,S.imageSource=r,S.trace[0]=n,C=!0}}}else S.trace.push(n),C=!0}),t([G],"touchmove mousemove",function(e){if(C){var t=e.changedTouches?e.changedTouches[0]:e,n={x:t.pageX,y:t.pageY};if("line"==S.style){var i=S.trace[S.trace.length-1];Math.abs(n.x-i.x)+Math.abs(n.y-i.y)>.3*V&&S.trace.push(n)}else S.trace[1]=n;ne.clearRect(0,0,b,x),y(ne,S)}}),t([G],"touchend touchcancel mouseup mouseleave",function(e){C&&(w.push(S),y(te,S),S={},ne.beginPath(),ne.clearRect(0,0,b,x),C=!1)}),t([clear],"touchstart mousedown",function(){S={},w=[],k=[],te.clearRect(0,0,b,x),te.beginPath()}),t([undo],"touchstart mousedown",function(){if(w.length>0){var e=w.pop();e.pos=w.length,k.push(e),te.clearRect(0,0,b,x),v()}}),t([redo],"touchstart mousedown",function(){if(k.length>0){for(var e,t=k.length-1;t>-1;t--){if(k[t].pos==w.length){e=k.pop();break}k.pop()}e&&(w.push(e),y(te,w[w.length-1]))}}),t([W],"touchstart mousedown",function(e){n([T]),n(F),i(O),i(U),o($),p=1}),t([P],"touchstart mousedown",function(e){n([T]),n(F),i(O),i(U),o(ee),p=2}),t([R],"touchstart mousedown",function(){i(F),i(U),n([T]),n(O)}),t([E],"touchstart mousedown",function(){i(F),i(O),n([T]),n(U)}),t([A,q,z,L],"change",function(e){var t=e.target;l([A.value,q.value,z.value,L.value]),t.previousElementSibling.innerText=t.value}),t([X],"change",function(e){var t=e.target;a(t.value),t.previousElementSibling.innerText=t.value}),t([Y],"change",function(e){var t=e.target;c(t.value),t.previousElementSibling.innerText=t.value}),t([B],"touchstart mousedown",function(t){c(0),Y.value=0,e(".rotatelabel span")[0].innerText=0}),t([styleSelecter],"change",function(e){var t=e.target;N=t.value})})();
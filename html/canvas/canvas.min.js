(function(){function e(e){var t=e.split(/\s+/);return"#"===t[t.length-1][0]?document.querySelector(e):document.querySelectorAll(e)}function t(e,t,n){for(var i=0;i<e.length;i++)for(var o=t.split(/\s+/),a=0;a<o.length;a++)x?o[a].indexOf("mouse")===-1&&e[i].addEventListener(o[a],function(e){n(e)},!1):e[i].addEventListener(o[a],function(e){n(e)},!1)}function n(e){for(var t=0;t<e.length;t++)e[t].style.display="initial"}function i(e){for(var t=0;t<e.length;t++)e[t].style.display="none"}function o(e,t){if(e.style.width=b+"px",e.width=b,e.style.height=w+"px",e.height=w,t){var n=e.getContext("2d");return n.strokeStyle=Z,n.fillColor=ee,n.lineWidth=V,n.lineCap="round",n}}function a(e){A.value=e[0],A.previousElementSibling.innerText=e[0],q.value=e[1],q.previousElementSibling.innerText=e[1],z.value=e[2],z.previousElementSibling.innerText=e[2],U.value=e[3],U.previousElementSibling.innerText=e[3]}function r(e){1===p?(Z="rgba("+e[0]+","+e[1]+","+e[2]+","+e[3]+")",$=e,D.style.borderColor=Z,H.style.background=Z):(ee="rgba("+e[0]+","+e[1]+","+e[2]+","+e[3]+")",te=e,I.style.background=ee)}function l(e){V=e,H.style.height=(V>12?12:V)+"px",H.style.background=Z}function c(e){Q=e,L.innerText=e}function s(e,t){var n=e.trace;if(n.length>3){t.beginPath(),t.lineWidth=e.lineWidth,t.strokeStyle=e.fillColor,t.moveTo(n[0].x,n[0].y);for(var i=1;i<n.length-2;i+=3)t.bezierCurveTo(n[i].x,n[i].y,n[i+1].x,n[i+1].y,n[i+2].x,n[i+2].y);t.lineTo(n[n.length-1].x,n[n.length-1].y)}t.stroke()}function u(e,t,n){var i=e.trace;if(i.length>1){n.beginPath(),n.lineWidth=e.lineWidth,n.strokeStyle=e.strokeColor,n.fillStyle=e.fillColor;var o=(i[1].x+i[0].x)/2,a=(i[1].x+i[0].x)/2;d(n,o,a,e.rotateDeg,function(){n.rect(i[0].x,i[0].y,i[1].x-i[0].x,i[1].y-i[0].y)}),0===t?n.stroke():1===t?n.fill():2==t&&(n.stroke(),n.fill())}}function h(e,t,n){var i=e.trace;if(i.length>1){n.beginPath(),n.lineWidth=e.lineWidth,n.strokeStyle=e.strokeColor,n.fillStyle=e.fillColor;var o=(i[1].x+i[0].x)/2,a=(i[1].y+i[0].y)/2,r=Math.sqrt(Math.pow(i[0].x-o,2)+Math.pow(i[0].y-a,2));n.arc(o,a,r,0,2*Math.PI),0===t?n.stroke():1===t?n.fill():2==t&&(n.stroke(),n.fill())}}function g(e,t){var n=e.trace;if(n.length>1){t.beginPath(),t.lineWidth=e.lineWidth,t.strokeStyle=e.strokeColor;var i=n[1].x-n[0].x,o=n[1].y-n[0].y,a=e.imageSource,r=(n[1].x+n[0].x)/2,l=(n[1].x+n[0].x)/2;d(t,r,l,e.rotateDeg,function(){t.drawImage(a,0,0,e.imgWidth,e.imgHeight,n[0].x,n[0].y,i,o)})}}function d(e,t,n,i,o){e.translate(t,n),e.rotate(Math.PI/180*i),e.translate(-t,-n),o(),e.translate(t,n),e.rotate(Math.PI/180*-i),e.translate(-t,-t)}function f(e,t){switch(e.style){case"line":s(e,t);break;case"rect":u(e,2,t);break;case"circle":h(e,2,t);break;case"strokerect":u(e,0,t);break;case"strokecircle":h(e,0,t);break;case"fillrect":u(e,1,t);break;case"fillcircle":h(e,1,t);break;case"fillrectimg":g(e,t)}}function v(){if(ne.clearRect(0,0,b,w),ne.beginPath(),ne.fillStyle="rgba(255,255,255,1)",ne.fillRect(0,0,b,w),k.length>0)for(var e=0;e<k.length;e++)f(k[e],ne)}function m(e,t){t.trace&&t.trace.length>1&&f(t,e)}var y,p,b=window.innerWidth,w=window.innerHeight,x=!!navigator.userAgent.match(/(iPhone|iPod|Android|ios)/i),k=[],S=[],C={},T=!1,W=e("#control"),P=e("#strokeColor"),R=e("#fillColor"),E=e("#linewidth"),M=e("#rotatedeg"),D=e("#strokeColor span")[0],I=e("#fillColor span")[0],H=e("#linewidth span")[0],L=e("#rotatedeg span")[0],A=e("#red"),q=e("#green"),z=e("#blue"),U=e("#opacity"),X=e("#width"),Y=e("#rotate"),B=e("#resetRotate"),F=e(".rgbalabel"),O=e(".widthlabel"),_=e(".rotatelabel");styleSelecter=e("#styleSelecter"),clear=e("#clear"),undo=e("#undo"),redo=e("#redo"),insertImg=e("#insertImg"),downloadimg=e("#downloadimg");var j=e("#canvas"),G=e("#canvasmask"),J=e("#fileimg"),K=e("#img"),N="line",Q=0,V=1,Z="rgba(0,0,0,1)",$=[0,0,0,1],ee="rgba(0,0,0,1)",te=[0,0,0,1],ne=o(j,!0),ie=o(G,!0);ne.fillStyle="rgba(255,255,255,1)",ne.fillRect(0,0,b,w),window.onresize=function(){b=window.innerWidth,w=window.innerHeight,o(j),o(G)};var oe=new FileReader;J.onchange=function(){var e=this;e=this.files[0],e.size<2097152?(oe.readAsDataURL(e),oe.onload=function(){y=this.result,K.src=y}):alert("图片不能大于2MB")},t([G],"touchstart mousedown",function(e){i([W]);var t=e.changedTouches?e.changedTouches[0]:e,n={x:t.pageX,y:t.pageY};if(C={style:N,lineWidth:V,strokeColor:Z,fillColor:ee,rotateDeg:Q,trace:[]},"fillrectimg"===N){if(y){var o=new Image;o.src=y,C.imgWidth=0,C.imgHeight=0,o.onload=function(){C.imgWidth=o.naturalWidth,C.imgHeight=o.naturalHeight,C.imageSource=o,C.trace[0]=n,T=!0}}}else C.trace.push(n),T=!0}),t([G],"touchmove mousemove",function(e){if(e.preventDefault(),T){var t=e.changedTouches?e.changedTouches[0]:e,n={x:t.pageX,y:t.pageY};if("line"==C.style){var i=C.trace[C.trace.length-1];Math.abs(n.x-i.x)+Math.abs(n.y-i.y)>.3*V&&C.trace.push(n)}else C.trace[1]=n;ie.clearRect(0,0,b,w),m(ie,C)}}),t([G],"touchend touchcancel mouseup mouseleave",function(e){T&&(k.push(C),m(ne,C),C={},ie.beginPath(),ie.clearRect(0,0,b,w),T=!1)}),t([clear],"touchstart mousedown",function(){C={},k=[],S=[],ne.clearRect(0,0,b,w),ne.beginPath()}),t([undo],"touchstart mousedown",function(){if(k.length>0){var e=k.pop();e.pos=k.length,S.push(e),ne.clearRect(0,0,b,w),v()}}),t([redo],"touchstart mousedown",function(){if(S.length>0){for(var e,t=S.length-1;t>-1;t--){if(S[t].pos==k.length){e=S.pop();break}S.pop()}e&&(k.push(e),m(ne,k[k.length-1]))}}),t([downloadimg],"touchstart mousedown",function(){x?downloadimg.href=j.toDataURL("image/png"):"download"in document.createElement("a")?(downloadimg.href=j.toDataURL("image/png"),downloadimg.download="作品_"+(new Date).getTime()+".png"):alert("浏览器不支持下载")}),t([P],"touchstart mousedown",function(e){n([W]),n(F),i(O),i(_),a($),p=1}),t([R],"touchstart mousedown",function(e){n([W]),n(F),i(O),i(_),a(te),p=2}),t([E],"touchstart mousedown",function(){i(F),i(_),n([W]),n(O)}),t([M],"touchstart mousedown",function(){i(F),i(O),n([W]),n(_)}),t([A,q,z,U],"change",function(e){var t=e.target;r([A.value,q.value,z.value,U.value]),t.previousElementSibling.innerText=t.value}),t([X],"change",function(e){var t=e.target;l(t.value),t.previousElementSibling.innerText=t.value}),t([Y],"change",function(e){var t=e.target;c(t.value),t.previousElementSibling.innerText=t.value}),t([B],"touchstart mousedown",function(t){c(0),Y.value=0,e(".rotatelabel span")[0].innerText=0}),t([styleSelecter],"change",function(e){var t=e.target;N=t.value})})();